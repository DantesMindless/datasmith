"""
Celery tasks for bulk permission operations
"""

import logging
from typing import List, Dict, Any
from celery import shared_task
from django.contrib.auth import get_user_model
from django.db import transaction

from .services import PermissionService
from .models import AccessType, DataSourcePermission, ColumnPermission
from .logging_utils import permission_logger, set_correlation_id, generate_correlation_id
from .cache_manager import cache_manager

User = get_user_model()
logger = logging.getLogger(__name__)


@shared_task(bind=True, max_retries=3, default_retry_delay=60)
def bulk_grant_column_permissions(
    self,
    user_ids: List[str],
    datasource_id: str,
    table_name: str,
    column_names: List[str],
    access_type: str = AccessType.READ,
    allow_in_segments: bool = False,
    granted_by_id: str = None,
    correlation_id: str = None
):
    """
    Celery task for bulk granting column permissions
    
    Args:
        user_ids: List of user IDs to grant permissions to
        datasource_id: DataSource ID
        table_name: Table name
        column_names: List of column names
        access_type: Access type (read, write, etc.)
        allow_in_segments: Whether to allow in ML segments
        granted_by_id: ID of user granting permissions
        correlation_id: Correlation ID for tracking
    """
    # Set correlation ID for logging
    if correlation_id:
        set_correlation_id(correlation_id)
    else:
        set_correlation_id(generate_correlation_id())
    
    try:\n        logger.info(\n            f\"Starting bulk column permission grant task: {len(user_ids)} users, \"\n            f\"{len(column_names)} columns\",\n            extra={\n                'task_id': self.request.id,\n                'user_count': len(user_ids),\n                'column_count': len(column_names),\n                'datasource_id': datasource_id,\n                'table_name': table_name\n            }\n        )\n        \n        # Get valid users\n        users = User.objects.filter(id__in=user_ids)\n        granted_by = User.objects.get(id=granted_by_id) if granted_by_id else None\n        \n        # Use PermissionService bulk operation\n        total_created, created_permissions = PermissionService.bulk_grant_permissions(\n            users=list(users),\n            datasource_id=datasource_id,\n            table_name=table_name,\n            column_names=column_names,\n            access_type=access_type,\n            allow_in_segments=allow_in_segments,\n            granted_by=granted_by\n        )\n        \n        # Log bulk operation\n        if granted_by:\n            permission_logger.bulk_operation(\n                operation_type='bulk_grant_column_permissions',\n                user=granted_by,\n                affected_count=total_created,\n                operation_details={\n                    'target_user_count': len(user_ids),\n                    'datasource_id': datasource_id,\n                    'table_name': table_name,\n                    'column_names': column_names,\n                    'access_type': access_type,\n                    'allow_in_segments': allow_in_segments,\n                    'task_id': self.request.id\n                }\n            )\n        \n        # Warm cache for affected users\n        for user in users:\n            cache_manager.warm_user_cache(str(user.id), [datasource_id])\n        \n        result = {\n            'status': 'success',\n            'total_created': total_created,\n            'created_permissions': created_permissions[:100],  # Limit response size\n            'total_users_processed': len(users),\n            'task_id': self.request.id\n        }\n        \n        logger.info(\n            f\"Completed bulk column permission grant: {total_created} permissions created\",\n            extra=result\n        )\n        \n        return result\n        \n    except Exception as exc:\n        logger.error(\n            f\"Bulk column permission grant failed: {exc}\",\n            extra={\n                'task_id': self.request.id,\n                'error': str(exc),\n                'user_ids': user_ids,\n                'datasource_id': datasource_id\n            },\n            exc_info=True\n        )\n        \n        # Log security violation if this looks suspicious\n        if granted_by:\n            permission_logger.security_violation(\n                user=granted_by,\n                violation_type='bulk_permission_failure',\n                details={\n                    'task_id': self.request.id,\n                    'error': str(exc),\n                    'attempted_user_count': len(user_ids),\n                    'datasource_id': datasource_id\n                }\n            )\n        \n        # Retry logic\n        if self.request.retries < self.max_retries:\n            logger.info(f\"Retrying bulk permission task {self.request.id} (attempt {self.request.retries + 1})\")\n            raise self.retry(countdown=60 * (2 ** self.request.retries))  # Exponential backoff\n        \n        raise exc


@shared_task(bind=True)\ndef revoke_user_all_permissions(\n    self,\n    user_id: str,\n    permission_types: List[str] = None,\n    revoked_by_id: str = None,\n    correlation_id: str = None\n):\n    \"\"\"\n    Celery task for revoking all permissions for a user\n    \n    Args:\n        user_id: User ID to revoke permissions from\n        permission_types: Types of permissions to revoke ['datasource', 'table', 'column']\n        revoked_by_id: ID of user performing revocation\n        correlation_id: Correlation ID for tracking\n    \"\"\"\n    if correlation_id:\n        set_correlation_id(correlation_id)\n    else:\n        set_correlation_id(generate_correlation_id())\n    \n    if permission_types is None:\n        permission_types = ['datasource', 'table', 'column']\n    \n    try:\n        user = User.objects.get(id=user_id)\n        revoked_by = User.objects.get(id=revoked_by_id) if revoked_by_id else None\n        \n        logger.info(\n            f\"Starting permission revocation for user {user.email}\",\n            extra={\n                'task_id': self.request.id,\n                'target_user_id': user_id,\n                'permission_types': permission_types\n            }\n        )\n        \n        revoked_counts = {\n            'datasource': 0,\n            'table': 0,\n            'column': 0\n        }\n        \n        with transaction.atomic():\n            if 'datasource' in permission_types:\n                # Revoke all datasource permissions\n                datasource_perms = DataSourcePermission.objects.filter(user=user)\n                for perm in datasource_perms:\n                    count, _ = PermissionService.revoke_datasource_permission(\n                        user=user,\n                        datasource_id=perm.datasource_id,\n                        access_type=perm.access_type,\n                        revoked_by=revoked_by\n                    )\n                    revoked_counts['datasource'] += count\n            \n            if 'column' in permission_types:\n                # Revoke all column permissions\n                column_perms = ColumnPermission.objects.filter(user=user)\n                for perm in column_perms:\n                    count, _ = PermissionService.revoke_column_permission(\n                        user=user,\n                        datasource_id=perm.datasource_id,\n                        table_name=perm.table_name,\n                        column_name=perm.column_name,\n                        access_type=perm.access_type,\n                        revoked_by=revoked_by\n                    )\n                    revoked_counts['column'] += count\n        \n        # Clear all user caches\n        cache_manager.invalidate_user_cache(str(user.id))\n        \n        # Log bulk revocation\n        if revoked_by:\n            permission_logger.bulk_operation(\n                operation_type='revoke_all_user_permissions',\n                user=revoked_by,\n                affected_count=sum(revoked_counts.values()),\n                operation_details={\n                    'target_user_id': user_id,\n                    'target_user_email': user.email,\n                    'permission_types': permission_types,\n                    'revoked_counts': revoked_counts,\n                    'task_id': self.request.id\n                }\n            )\n        \n        result = {\n            'status': 'success',\n            'revoked_counts': revoked_counts,\n            'total_revoked': sum(revoked_counts.values()),\n            'user_email': user.email,\n            'task_id': self.request.id\n        }\n        \n        logger.info(\n            f\"Completed permission revocation for user {user.email}: {sum(revoked_counts.values())} permissions\",\n            extra=result\n        )\n        \n        return result\n        \n    except Exception as exc:\n        logger.error(\n            f\"Permission revocation failed for user {user_id}: {exc}\",\n            extra={\n                'task_id': self.request.id,\n                'user_id': user_id,\n                'error': str(exc)\n            },\n            exc_info=True\n        )\n        raise exc


@shared_task(bind=True)\ndef copy_user_permissions(\n    self,\n    source_user_id: str,\n    target_user_ids: List[str],\n    permission_types: List[str] = None,\n    copied_by_id: str = None,\n    correlation_id: str = None\n):\n    \"\"\"\n    Celery task for copying permissions from one user to multiple users\n    \n    Args:\n        source_user_id: ID of user to copy permissions from\n        target_user_ids: List of user IDs to copy permissions to\n        permission_types: Types of permissions to copy\n        copied_by_id: ID of user performing the copy\n        correlation_id: Correlation ID for tracking\n    \"\"\"\n    if correlation_id:\n        set_correlation_id(correlation_id)\n    else:\n        set_correlation_id(generate_correlation_id())\n    \n    if permission_types is None:\n        permission_types = ['datasource', 'table', 'column']\n    \n    try:\n        source_user = User.objects.get(id=source_user_id)\n        target_users = User.objects.filter(id__in=target_user_ids)\n        copied_by = User.objects.get(id=copied_by_id) if copied_by_id else None\n        \n        logger.info(\n            f\"Starting permission copy from {source_user.email} to {len(target_users)} users\",\n            extra={\n                'task_id': self.request.id,\n                'source_user_id': source_user_id,\n                'target_user_count': len(target_users),\n                'permission_types': permission_types\n            }\n        )\n        \n        results = []\n        total_copied = 0\n        \n        for target_user in target_users:\n            copied_counts = PermissionService.copy_user_permissions(\n                source_user=source_user,\n                target_user=target_user,\n                permission_types=permission_types,\n                copied_by=copied_by\n            )\n            \n            user_total = sum(copied_counts.values())\n            total_copied += user_total\n            \n            results.append({\n                'target_user_id': str(target_user.id),\n                'target_user_email': target_user.email,\n                'copied_counts': copied_counts,\n                'total_copied': user_total\n            })\n            \n            # Warm cache for target user\n            cache_manager.warm_user_cache(str(target_user.id))\n        \n        # Log bulk copy operation\n        if copied_by:\n            permission_logger.bulk_operation(\n                operation_type='copy_user_permissions',\n                user=copied_by,\n                affected_count=total_copied,\n                operation_details={\n                    'source_user_id': source_user_id,\n                    'source_user_email': source_user.email,\n                    'target_user_count': len(target_users),\n                    'permission_types': permission_types,\n                    'task_id': self.request.id\n                }\n            )\n        \n        result = {\n            'status': 'success',\n            'source_user_email': source_user.email,\n            'target_results': results,\n            'total_permissions_copied': total_copied,\n            'task_id': self.request.id\n        }\n        \n        logger.info(\n            f\"Completed permission copy: {total_copied} permissions copied to {len(target_users)} users\",\n            extra=result\n        )\n        \n        return result\n        \n    except Exception as exc:\n        logger.error(\n            f\"Permission copy failed: {exc}\",\n            extra={\n                'task_id': self.request.id,\n                'source_user_id': source_user_id,\n                'target_user_ids': target_user_ids,\n                'error': str(exc)\n            },\n            exc_info=True\n        )\n        raise exc


@shared_task\ndef warm_user_caches(user_ids: List[str], datasources: List[str] = None):\n    \"\"\"\n    Celery task to warm caches for multiple users\n    \n    Args:\n        user_ids: List of user IDs to warm caches for\n        datasources: Optional list of datasource IDs to focus on\n    \"\"\"\n    logger.info(f\"Starting cache warming for {len(user_ids)} users\")\n    \n    warmed_count = 0\n    for user_id in user_ids:\n        try:\n            cache_manager.warm_user_cache(user_id, datasources)\n            warmed_count += 1\n        except Exception as e:\n            logger.warning(f\"Failed to warm cache for user {user_id}: {e}\")\n    \n    logger.info(f\"Cache warming completed: {warmed_count}/{len(user_ids)} users\")\n    \n    return {\n        'status': 'success',\n        'users_requested': len(user_ids),\n        'users_warmed': warmed_count,\n        'datasources': datasources\n    }


@shared_task\ndef cleanup_expired_permissions():\n    \"\"\"\n    Celery task to clean up expired permissions\n    \"\"\"\n    from datetime import timezone as tz\n    from datetime import datetime\n    \n    logger.info(\"Starting expired permissions cleanup\")\n    \n    now = datetime.now(tz.utc)\n    \n    # Clean expired datasource permissions\n    expired_ds = DataSourcePermission.objects.filter(expires_at__lt=now)\n    ds_count = expired_ds.count()\n    expired_ds.delete()\n    \n    # Clean expired column permissions\n    expired_col = ColumnPermission.objects.filter(expires_at__lt=now)\n    col_count = expired_col.count()\n    expired_col.delete()\n    \n    # Clear permission cache to ensure consistency\n    cleared_keys = cache_manager.clear_all_permission_cache()\n    \n    result = {\n        'status': 'success',\n        'expired_datasource_permissions': ds_count,\n        'expired_column_permissions': col_count,\n        'total_expired': ds_count + col_count,\n        'cache_keys_cleared': cleared_keys\n    }\n    \n    logger.info(\n        f\"Expired permissions cleanup completed: {ds_count + col_count} permissions removed\",\n        extra=result\n    )\n    \n    return result